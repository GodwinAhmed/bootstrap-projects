/**
 * Created by Administrator on 2016/7/15 0015.
 */
var fs = require('fs');
var path = require('path');
var crypto = require('crypto');
var Buffer = require('buffer').Buffer;
var gutil = require('gulp-util');
var PluginError = gutil.PluginError;
var map = require('event-stream').map;

var repVPlugin = function(obj){
    return map(function(file,cb){
        if(!file){
            throw new PluginError('gulp-version-replace', 'Missing file option for gulp-version-replace.');
        }
        if(!file.contents) {
            throw new PluginError('gulp-version-replace', 'Missing file.contents required for modifying files using gulp-version-replace.');
        }
        try{
            var data = fs.readFileSync(file.path);
            var hash = crypto.createHash('md5');
            hash.update(data.toString(), 'utf8');
            //需要输出的链接
            var fileContents = '<link rel="stylesheet" href="{!! asset(\''+(file.path.match(/wechat(\S*).css/)[0]).replace(/\\/g,'/')+'\') !!}?kw='+hash.digest('hex')+'" />';
            file.contents = new Buffer(fileContents);
        }catch (e){

        }
        cb(null, file);
    });
}


module.exports = repVPlugin;